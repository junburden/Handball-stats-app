//= depend_on_asset "handball goal.png"
//= depend_on_asset "handball-invert.png"

function goalClickHandler(event) {
  var handball = document.querySelector("#handball");
  var goal = $("input[name='shot[goal]']:checkbox")
  if(goal.is(":checked")){
    handball.src='<%= asset_path("handball.png") %>';
  } else{
    handball.src='<%= asset_path("handball-invert.png") %>';
  }
}

function canvasClickHandler(event) {
  event = event || window.event
  var xInput = document.querySelector("#shot_x_position");
  var yInput = document.querySelector("#shot_y_position");
  var handball = document.querySelector("#handball");
  var parentPosition = getPosition(event.currentTarget);
  var xPosition = event.clientX - parentPosition.x;
  var yPosition = event.clientY - parentPosition.y;

  x = (xPosition - 380) / 2;
  y = (480 - yPosition) / 2;

  handball.style.left = (xPosition - 19) + "px";
  handball.style.top = (yPosition - 19) + "px";

  xInput.value = x;
  yInput.value = y;
}

function getPosition(el) {
  var xPos = 0;
  var yPos = 0;

  while (el) {
    if (el.tagName == "BODY") {
      // deal with browser quirks with body/window/document and page scroll
      var xScroll = el.scrollLeft || document.documentElement.scrollLeft;
      var yScroll = el.scrollTop || document.documentElement.scrollTop;

      xPos += (el.offsetLeft - xScroll + el.clientLeft);
      yPos += (el.offsetTop - yScroll + el.clientTop);
    } else {
      // for all other non-BODY elements
      xPos += (el.offsetLeft - el.scrollLeft + el.clientLeft);
      yPos += (el.offsetTop - el.scrollTop + el.clientTop);
    }

    el = el.offsetParent;
  }
  return {
    x: xPos,
    y: yPos
  };
}

function teamDiv(value, name) {
  return $("<div class='col-xs-6'><label data-value='" + value + "' for='shot_team_id_" + value + "'><input onClick='teamChangeHandler(this)' type='radio' value='" + value + "' name='shot[team_id]' id='shot_team_id_" + value + "'> " + name + "</label></div>")
}

function getTeamsForGame(game_id) {
  $.get('<%= Rails.application.routes.url_helpers.teams_path %>.json', {game_id: game_id})
  .done(function(data) {
    var teams = $('[for="shot_team_id"]').siblings()
    teams.children().not(':first').remove();
    $.each(data, function(i, team) {
      teams.append(teamDiv(team.id, team.name));
    });
  });
}

function gameChangeHandler(el) {
  var gameId = el[el.selectedIndex].value;
  getTeamsForGame(gameId);
}

function getPlayersForTeam(team_id, el_id, goalies) {
  $.get('<%= Rails.application.routes.url_helpers.players_path %>.json', {team_id: team_id})
  .done(function(data) {
    $(el_id).empty();
    if(!goalies){
      $(el_id).append($("<option>", {
        text: "Please select"
      }));
    } else {
      data.reverse();
    };
    $.each(data, function(i, player) {
      $(el_id).append($("<option>", {
        value: player.id,
        text: player.name
      }));
    });
  });
}

function teamChangeHandler(el) {
  var teams = $('input[name="' + el.name + '"]')
  var shooterTeamId = parseInt(el.value);
  var goalieTeamId = parseInt(teams[1].value) + parseInt(teams[2].value) - shooterTeamId;
  getPlayersForTeam(shooterTeamId, "#shot_shooter_id", false);
  getPlayersForTeam(goalieTeamId, "#shot_goalie_id", true);
}
