//= depend_on_asset "handball goal.png"
//= depend_on_asset "handball-invert.png"

function goalClickHandler(event) {
  var handball = document.querySelector("#handball");
  var goal = $("input[name='shot[goal]']:checkbox")
  if(goal.is(":checked")){
    handball.src='<%= asset_path("handball.png") %>';
  } else{
    handball.src='<%= asset_path("handball-invert.png") %>';
  }
}

function canvasClickHandler(event) {
  event = event || window.event
  var xInput = document.querySelector("#shot_x_position");
  var yInput = document.querySelector("#shot_y_position");
  var handball = document.querySelector("#handball");
  var parentPosition = getPosition(event.currentTarget);
  var xPosition = event.clientX - parentPosition.x;
  var yPosition = event.clientY - parentPosition.y;

  x = (xPosition - 380) / 2;
  y = (480 - yPosition) / 2;

  handball.style.left = (xPosition - 19) + "px";
  handball.style.top = (yPosition - 19) + "px";

  xInput.value = x;
  yInput.value = y;
}

function getPosition(el) {
  var xPos = 0;
  var yPos = 0;

  while (el) {
    if (el.tagName == "BODY") {
      // deal with browser quirks with body/window/document and page scroll
      var xScroll = el.scrollLeft || document.documentElement.scrollLeft;
      var yScroll = el.scrollTop || document.documentElement.scrollTop;

      xPos += (el.offsetLeft - xScroll + el.clientLeft);
      yPos += (el.offsetTop - yScroll + el.clientTop);
    } else {
      // for all other non-BODY elements
      xPos += (el.offsetLeft - el.scrollLeft + el.clientLeft);
      yPos += (el.offsetTop - el.scrollTop + el.clientTop);
    }

    el = el.offsetParent;
  }
  return {
    x: xPos,
    y: yPos
  };
}

function getTeamsForGame(game_id, el_id) {
  $.get('<%= Rails.application.routes.url_helpers.teams_path %>.json', {game_id: game_id})
  .done(function(data) {
    $(el_id).empty();
    $(el_id).append($("<option>", {
      text: "Please select"
    }));
    $.each(data, function(i, team) {
      $(el_id).append($("<option>", {
        value: team.id,
        text: team.name
      }));
    });
  });
}

function gameChangeHandler(el) {
  var gameId = el[el.selectedIndex].value;
  getTeamsForGame(gameId, "#shot_team_id");
}

function getPlayersForTeam(team_id, el_id) {
  $.get('<%= Rails.application.routes.url_helpers.players_path %>.json', {team_id: team_id})
  .done(function(data) {
    $(el_id).empty();
    $(el_id).append($("<option>", {
      text: "Please select"
    }));
    $.each(data, function(i, player) {
      $(el_id).append($("<option>", {
        value: player.id,
        text: player.name
      }));
    });
  });
}

function teamChangeHandler(el) {
  var shooterTeamId = parseInt(el[el.selectedIndex].value);
  var goalieTeamId = parseInt(el[el.length-1].value) + parseInt(el[el.length-2].value) - shooterTeamId;
  getPlayersForTeam(shooterTeamId, "#shot_shooter_id");
  getPlayersForTeam(goalieTeamId, "#shot_goalie_id");
}
